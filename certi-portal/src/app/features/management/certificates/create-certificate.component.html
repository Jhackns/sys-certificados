<div class="create-certificate-container">
  <div class="header">
    <h2 class="title">
      <i class="fas fa-certificate"></i>
      Crear Nuevo Certificado
    </h2>
    <p class="subtitle">Complete los datos para generar un nuevo certificado</p>
  </div>

  <!-- Loading State -->
  <div *ngIf="isLoading()" class="loading-container">
    <div class="spinner"></div>
    <p>Cargando datos del formulario...</p>
  </div>

  <!-- Error Message -->
  <div *ngIf="errorMessage()" class="alert alert-error">
    <i class="fas fa-exclamation-triangle"></i>
    {{ errorMessage() }}
  </div>

  <!-- Success Message -->
  <div *ngIf="successMessage()" class="alert alert-success">
    <i class="fas fa-check-circle"></i>
    {{ successMessage() }}
  </div>

  <!-- Main Content -->
  <div *ngIf="!isLoading()" class="content-grid">
    <!-- Form Section -->
    <div class="form-section">
      <form [formGroup]="certificateForm" (ngSubmit)="onSubmit()" class="certificate-form">

        <!-- Usuario Field -->
        <div class="form-group">
          <label for="user_id" class="form-label">
            Usuario <span class="required">*</span>
          </label>
          <select
            id="user_id"
            formControlName="user_id"
            class="form-input"
            [class.invalid]="userIdInvalid">
            <option value="">Seleccione un usuario</option>
            <option *ngFor="let user of users()" [value]="user.id">
              {{ user.name }} - {{ user.email }}
            </option>
          </select>
          <div *ngIf="userIdInvalid" class="error-message">
            <i class="fas fa-exclamation-circle"></i>
            El usuario es requerido
          </div>
        </div>

        <!-- Actividad Field -->
        <div class="form-group">
          <label for="activity_id" class="form-label">
            Actividad <span class="required">*</span>
          </label>
          <select
            id="activity_id"
            formControlName="activity_id"
            class="form-input"
            [class.invalid]="activityIdInvalid">
            <option value="">Seleccione una actividad</option>
            <option *ngFor="let activity of activities()" [value]="activity.id">
              {{ activity.name }} - {{ activity.type }}
            </option>
          </select>
          <div *ngIf="activityIdInvalid" class="error-message">
            <i class="fas fa-exclamation-circle"></i>
            La actividad es requerida
          </div>
        </div>

        <!-- Plantilla Field -->
        <div class="form-group">
          <label for="id_template" class="form-label">
            Plantilla <span class="required">*</span>
          </label>
          <select
            id="id_template"
            formControlName="id_template"
            class="form-input"
            [class.invalid]="templateIdInvalid"
            (change)="onTemplateChange($event)">
            <option value="">Seleccione una plantilla</option>
            <option *ngFor="let template of templates()" [value]="template.id">
              {{ template.name }}
            </option>
          </select>
          <div *ngIf="templateIdInvalid" class="error-message">
            <i class="fas fa-exclamation-circle"></i>
            La plantilla es requerida
          </div>
        </div>

        <!-- Nombre Field -->
        <div class="form-group">
          <label for="nombre" class="form-label">
            Nombre del Certificado <span class="required">*</span>
          </label>
          <input
            type="text"
            id="nombre"
            formControlName="nombre"
            class="form-input"
            [class.invalid]="nombreInvalid"
            placeholder="Ingrese el nombre del certificado">
          <div *ngIf="nombreInvalid" class="error-message">
            <i class="fas fa-exclamation-circle"></i>
            <span *ngIf="certificateForm.get('nombre')?.errors?.['required']">
              El nombre es requerido
            </span>
            <span *ngIf="certificateForm.get('nombre')?.errors?.['minlength']">
              El nombre debe tener al menos 3 caracteres
            </span>
            <span *ngIf="certificateForm.get('nombre')?.errors?.['maxlength']">
              El nombre no puede exceder 255 caracteres
            </span>
          </div>
        </div>

        <!-- Descripción Field -->
        <div class="form-group">
          <label for="descripcion" class="form-label">
            Descripción
          </label>
          <textarea
            id="descripcion"
            formControlName="descripcion"
            class="form-input"
            [class.invalid]="descripcionInvalid"
            rows="3"
            placeholder="Descripción opcional del certificado">
          </textarea>
          <div *ngIf="descripcionInvalid" class="error-message">
            <i class="fas fa-exclamation-circle"></i>
            <span *ngIf="certificateForm.get('descripcion')?.errors?.['maxlength']">
              La descripción no puede exceder 1000 caracteres
            </span>
          </div>
        </div>

        <!-- Fecha de Emisión Field -->
        <div class="form-group">
          <label for="fecha_emision" class="form-label">
            Fecha de Emisión <span class="required">*</span>
          </label>
          <input
            type="date"
            id="fecha_emision"
            formControlName="fecha_emision"
            class="form-input"
            [class.invalid]="fechaEmisionInvalid">
          <div *ngIf="fechaEmisionInvalid" class="error-message">
            <i class="fas fa-exclamation-circle"></i>
            La fecha de emisión es requerida
          </div>
        </div>

        <!-- Fecha de Vencimiento Field -->
        <div class="form-group">
          <label for="fecha_vencimiento" class="form-label">
            Fecha de Vencimiento
          </label>
          <input
            type="date"
            id="fecha_vencimiento"
            formControlName="fecha_vencimiento"
            class="form-input"
            [class.invalid]="fechaVencimientoInvalid">
          <div *ngIf="fechaVencimientoInvalid" class="error-message">
            <i class="fas fa-exclamation-circle"></i>
            La fecha de vencimiento debe ser posterior a la fecha de emisión
          </div>
        </div>

        <!-- Firmado por Field -->
        <div class="form-group">
          <label for="signed_by" class="form-label">
            Firmado por
          </label>
          <input
            type="text"
            id="signed_by"
            formControlName="signed_by"
            class="form-input"
            [class.invalid]="signedByInvalid"
            placeholder="Nombre de quien firma el certificado">
          <div *ngIf="signedByInvalid" class="error-message">
            <i class="fas fa-exclamation-circle"></i>
            <span *ngIf="certificateForm.get('signed_by')?.errors?.['maxlength']">
              El nombre no puede exceder 255 caracteres
            </span>
          </div>
        </div>

        <!-- Form Actions -->
        <div class="form-actions">
          <button
            type="button"
            class="btn btn-secondary"
            (click)="onCancel()"
            [disabled]="isSubmitting()">
            <i class="fas fa-times"></i>
            Cancelar
          </button>
          <button
            type="submit"
            class="btn btn-primary"
            [disabled]="certificateForm.invalid || isSubmitting()">
            <i class="fas fa-spinner fa-spin" *ngIf="isSubmitting()"></i>
            <i class="fas fa-save" *ngIf="!isSubmitting()"></i>
            {{ isSubmitting() ? 'Creando...' : 'Crear Certificado' }}
          </button>
        </div>
      </form>
    </div>

    <!-- Preview Section -->
    <div class="preview-section">
      <div class="preview-header">
        <h3 class="preview-title">
          <i class="fas fa-eye"></i>
          Vista Previa
        </h3>
      </div>

      <div class="preview-container">
        <!-- No Template Selected -->
        <div *ngIf="!certificateForm.get('id_template')?.value" class="preview-placeholder">
          <i class="fas fa-file-alt"></i>
          <p>Seleccione una plantilla para ver la vista previa</p>
        </div>

        <!-- Loading Preview -->
        <div *ngIf="isLoadingPreview()" class="preview-loading">
          <div class="spinner"></div>
          <p>Cargando vista previa...</p>
        </div>

        <!-- Template Preview -->
        <div *ngIf="templatePreview() && !isLoadingPreview()" class="preview-content">
          <div class="preview-info">
            <h4>{{ templatePreview()?.name }}</h4>
            <p *ngIf="templatePreview()?.description">{{ templatePreview()?.description }}</p>
            <p *ngIf="templatePreview()?.company" class="company-info">
              <i class="fas fa-building"></i>
              {{ templatePreview()?.company?.name }}
            </p>
          </div>

          <div class="preview-frame">
            <div
              class="certificate-preview"
              [innerHTML]="templatePreview()?.html_content"
              [style]="templatePreview()?.css_styles">
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
