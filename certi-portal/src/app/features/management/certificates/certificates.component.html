<div class="page">
  <div class="page-header">
    <div>
      <h1>Gestión de Certificados</h1>
      <p>Administra todos los certificados del sistema</p>
    </div>
    <div class="header-actions">
      <button class="btn btn-primary" (click)="openCreateModal()">Nuevo Certificado</button>
    </div>
  </div>

  <div class="content-card">
          <!-- Filtros -->
          <form [formGroup]="filterForm" (ngSubmit)="applyFilters()" class="filters">
            <input class="input" type="text" placeholder="Buscar por nombre o código" formControlName="search">
            <select class="input" formControlName="status">
              <option value="">Todos</option>
              <option value="issued">Emitido</option>
              <option value="pending">Pendiente</option>
              <option value="cancelled">Cancelado</option>
              <option value="expired">Expirado</option>
            </select>
            <select class="input" formControlName="template_id">
              <option value="">Todas las plantillas</option>
              <option *ngFor="let template of templates()" [value]="template.id">{{ template.name }}</option>
            </select>
            <input class="input" type="date" placeholder="Fecha emisión desde" formControlName="fecha_emision">
            <input class="input" type="date" placeholder="Fecha vencimiento hasta" formControlName="fecha_vencimiento">
            <button class="btn" type="submit">Filtrar</button>
            <button class="btn btn-outline" type="button" (click)="resetFilters()">Limpiar</button>
          </form>

          <!-- Mensajes -->
          <div *ngIf="errorMessage()" class="alert alert-danger">
            {{ errorMessage() }}
          </div>
          <div *ngIf="successMessage()" class="alert alert-success">
            {{ successMessage() }}
          </div>

          <!-- Tabla de certificados -->
          <div class="table-responsive">
            <table class="table">
              <thead>
                <tr>
                  <th>Código</th>
                  <th>Nombre</th>
                  <th>Usuario</th>
                  <th>Plantilla</th>
                  <th>Actividad</th>
                  <th>Fecha de emisión</th>
                  <th>Estado</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngIf="isLoading()">
                  <td colspan="8" class="text-center">Cargando...</td>
                </tr>
                <tr *ngIf="!isLoading() && certificates().length === 0">
                  <td colspan="8" class="text-center">No se encontraron certificados</td>
                </tr>
                <tr *ngFor="let certificate of certificates()">
                  <td>{{ certificate.unique_code }}</td>
                  <td>{{ certificate.nombre }}</td>
                  <td>{{ certificate.user?.name || 'N/A' }}</td>
                  <td>{{ certificate.template?.name || 'N/A' }}</td>
                  <td>{{ certificate.activity?.name || 'N/A' }}</td>
                  <td>{{ formatDate(certificate.fecha_emision) }}</td>
                  <td>
                    <span class="badge badge-{{ getStatusColor(certificate.status) }}">
                      {{ getStatusText(certificate.status) }}
                    </span>
                  </td>
                  <td>
                    <div class="actions">
                      <button class="btn btn-sm" (click)="openViewModal(certificate)">Ver</button>
                      <button class="btn btn-sm" (click)="downloadCertificate(certificate.id)">Descargar</button>
                      <button class="btn btn-sm" (click)="sendCertificateEmail(certificate.id)">Enviar</button>
                      <button class="btn btn-sm" (click)="openEditModal(certificate)">Editar</button>
                      <button class="btn btn-sm btn-danger" (click)="openDeleteModal(certificate)">Eliminar</button>
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>

          <!-- Paginación -->
          <div class="row" *ngIf="!isLoading() && totalPages() > 1">
            <div class="col-12">
              <nav>
                <ul class="pagination justify-content-center">
                  <li class="page-item" [class.disabled]="currentPage() === 1">
                    <a class="page-link" href="javascript:void(0)" (click)="goToPage(currentPage() - 1)">Anterior</a>
                  </li>
                  <li class="page-item" *ngFor="let page of [].constructor(totalPages()); let i = index"
                      [class.active]="currentPage() === i + 1">
                    <a class="page-link" href="javascript:void(0)" (click)="goToPage(i + 1)">{{ i + 1 }}</a>
                  </li>
                  <li class="page-item" [class.disabled]="currentPage() === totalPages()">
                    <a class="page-link" href="javascript:void(0)" (click)="goToPage(currentPage() + 1)">Siguiente</a>
                  </li>
                </ul>
              </nav>
            </div>
          </div>
  </div>

  <!-- Modal Crear -->
  <div class="modal-overlay" *ngIf="showCreateModal()" (click)="closeModals()">
    <div class="modal-content modal-large" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>Nuevo Certificado</h3>
        <button class="modal-close" (click)="closeModals()">&times;</button>
      </div>
      <div class="modal-body-flex">
        <form [formGroup]="createForm" (ngSubmit)="createCertificate()" class="modal-form">
          <div class="form-row">
            <div class="form-group">
              <label>Nombre del certificado</label>
              <input class="form-control" type="text" formControlName="nombre" placeholder="Certificado de Participación" />
            </div>
            <div class="form-group">
              <label>Usuario</label>
              <select class="form-control" formControlName="user_id">
                <option value="">Seleccione usuario</option>
                <option *ngFor="let user of users()" [value]="user.id">{{ user.name }} ({{ user.email }})</option>
              </select>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Descripción (opcional)</label>
              <textarea class="form-control" formControlName="descripcion" placeholder="Descripción del certificado"></textarea>
            </div>
            <div class="form-group">
              <label>Actividad</label>
              <select class="form-control" formControlName="activity_id">
                <option value="">Seleccione actividad</option>
                <option *ngFor="let a of activities()" [value]="a.id">{{ a.name }}</option>
              </select>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Plantilla</label>
              <select class="form-control" formControlName="id_template" (change)="onTemplateChange($any($event.target).value)">
                <option value="">Seleccione plantilla</option>
                <option *ngFor="let t of templates()" [value]="t.id">{{ t.name }}</option>
              </select>
            </div>
            <div class="form-group">
              <label>Fecha de emisión</label>
              <input class="form-control" type="date" formControlName="fecha_emision" />
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Fecha de vencimiento (opcional)</label>
              <input class="form-control" type="date" formControlName="fecha_vencimiento" />
            </div>
            <div class="form-group">
              <label>Firmado por (opcional)</label>
              <select class="form-control" formControlName="signed_by">
                <option value="">Sin firmar</option>
                <option *ngFor="let user of users()" [value]="user.id">{{ user.name }}</option>
              </select>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Estado</label>
              <select class="form-control" formControlName="status">
                <option value="issued">Emitido</option>
                <option value="pending">Pendiente</option>
                <option value="cancelled">Cancelado</option>
                <option value="expired">Expirado</option>
              </select>
            </div>
          </div>
          <div class="modal-actions">
            <button type="button" class="btn btn-outline" (click)="closeModals()">Cancelar</button>
            <button type="submit" class="btn btn-primary" [disabled]="createForm.invalid || isLoading()">{{ isLoading() ? 'Creando...' : 'Crear' }}</button>
          </div>
        </form>

        <!-- Vista previa de plantilla -->
        <div class="template-preview">
          <h4>Vista Previa de Plantilla</h4>
          <div class="preview-container" *ngIf="selectedTemplate(); else noTemplate">
            <div class="template-info">
              <h5>{{ selectedTemplate()?.name }}</h5>
              <p *ngIf="selectedTemplate()?.description">{{ selectedTemplate()?.description }}</p>
            </div>
            <div class="preview-image" *ngIf="templatePreview(); else noPreview">
              <img [src]="templatePreview()" [alt]="selectedTemplate()?.name" class="template-img" />
            </div>
            <ng-template #noPreview>
              <div class="no-preview">
                <i class="fas fa-file-image"></i>
                <p>Vista previa no disponible</p>
              </div>
            </ng-template>
          </div>
          <ng-template #noTemplate>
            <div class="no-template">
              <i class="fas fa-file-alt"></i>
              <p>Seleccione una plantilla para ver la vista previa</p>
            </div>
          </ng-template>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal para ver detalles -->
<div class="modal fade" [class.show]="showViewModal()" [style.display]="showViewModal() ? 'block' : 'none'" tabindex="-1" role="dialog">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Detalles del Certificado</h5>
        <button type="button" class="close" (click)="closeModals()">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body" *ngIf="selectedCertificate()">
        <div class="row">
          <div class="col-md-6">
            <p><strong>Código:</strong> {{ selectedCertificate()?.unique_code }}</p>
            <p><strong>Nombre:</strong> {{ selectedCertificate()?.nombre }}</p>
            <p><strong>Descripción:</strong> {{ selectedCertificate()?.descripcion || 'N/A' }}</p>
            <p><strong>Usuario:</strong> {{ selectedCertificate()?.user?.name || 'N/A' }}</p>
            <p><strong>Email:</strong> {{ selectedCertificate()?.user?.email || 'N/A' }}</p>
          </div>
          <div class="col-md-6">
            <p><strong>Actividad:</strong> {{ selectedCertificate()?.activity?.name || 'N/A' }}</p>
            <p><strong>Plantilla:</strong> {{ selectedCertificate()?.template?.name || 'N/A' }}</p>
            <p><strong>Fecha de emisión:</strong> {{ formatDate(selectedCertificate()?.fecha_emision) }}</p>
            <p><strong>Fecha de vencimiento:</strong> {{ formatDate(selectedCertificate()?.fecha_vencimiento) }}</p>
            <p><strong>Firmado por:</strong> {{ selectedCertificate()?.signer?.name || 'N/A' }}</p>
            <p><strong>Estado:</strong>
              <span class="badge badge-{{ getStatusColor(selectedCertificate()?.status || '') }}">
                {{ getStatusText(selectedCertificate()?.status || '') }}
              </span>
            </p>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" (click)="downloadCertificate(selectedCertificate()?.id || 0)">
          <i class="fas fa-download"></i> Descargar
        </button>
        <button type="button" class="btn btn-success" (click)="sendCertificateEmail(selectedCertificate()?.id || 0)">
          <i class="fas fa-envelope"></i> Enviar por Email
        </button>
        <button type="button" class="btn btn-secondary" (click)="closeModals()">Cerrar</button>
      </div>
    </div>
  </div>
</div>

<!-- Overlay para modales -->
<div class="modal-backdrop fade show" *ngIf="showViewModal() || showCreateModal() || showEditModal() || showDeleteModal()"></div>
