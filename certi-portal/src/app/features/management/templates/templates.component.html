<div class="templates-page">
  <!-- Header -->
  <div class="page-header">
    <div>
      <h1>Gestión de Plantillas</h1>
      <p>Administra las plantillas de certificados del sistema</p>
    </div>
    <button class="btn btn-primary" (click)="openCreateModal()">
      <i class="fas fa-plus"></i>
      Nueva Plantilla
    </button>
  </div>

  <!-- Mensajes de alerta -->
  <div class="alert alert-success" *ngIf="successMessage()">
    <i class="fas fa-check-circle"></i>
    {{ successMessage() }}
  </div>

  <div class="alert alert-error" *ngIf="errorMessage()">
    <i class="fas fa-exclamation-circle"></i>
    {{ errorMessage() }}
  </div>

  <!-- Filtros -->
  <div class="filters-section">
    <form [formGroup]="filterForm" class="filters-form">
      <div class="search-box">
        <i class="fas fa-search"></i>
        <input type="text" class="form-control" placeholder="Buscar plantillas..." formControlName="search">
      </div>

      <div class="filter-group">
        <select class="form-control" formControlName="activity_type">
          <option value="">Todos los tipos</option>
          <option *ngFor="let type of activityTypes" [value]="type.value">
            {{ type.label }}
          </option>
        </select>

        <select class="form-control" formControlName="status">
          <option value="">Todos los estados</option>
          <option *ngFor="let status of statusOptions" [value]="status.value">
            {{ status.label }}
          </option>
        </select>

        <button type="button" class="btn btn-primary" (click)="applyFilters()">
          <i class="fas fa-filter"></i>
          Filtrar
        </button>

        <button type="button" class="btn btn-secondary" (click)="clearFilters()">
          <i class="fas fa-times"></i>
          Limpiar
        </button>
      </div>
    </form>
  </div>

  <!-- Tabla de plantillas -->
  <div class="table-container">
    <!-- Loading State -->
    <div *ngIf="isLoading()" class="loading-state">
      <div class="loading-spinner"></div>
      <p>Cargando plantillas...</p>
    </div>

    <!-- Error State -->
    <div *ngIf="errorMessage() && !isLoading()" class="error-state">
      <div class="error-icon">
        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="10" />
          <line x1="15" y1="9" x2="9" y2="15" />
          <line x1="9" y1="9" x2="15" y2="15" />
        </svg>
      </div>
      <h3>Error al cargar plantillas</h3>
      <p>{{ errorMessage() }}</p>
      <button class="btn btn-primary" (click)="loadTemplates()">Reintentar</button>
    </div>

    <!-- Templates Table -->
    <div *ngIf="!isLoading() && !errorMessage()" class="templates-content">
      <table class="templates-table">
        <thead>
          <tr>
            <th>Vista Previa</th>
            <th>Nombre</th>
            <th>Tipo de Actividad</th>
            <th>Estado</th>
            <th>Fecha de Creación</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngIf="filteredTemplates().length === 0">
            <td colspan="6" class="empty-row">
              <div class="empty-state">
                <i class="fas fa-file-alt"></i>
                <p>No se encontraron plantillas</p>
              </div>
            </td>
          </tr>

          <tr *ngFor="let template of filteredTemplates()" class="template-row">
            <td>
              <div class="template-preview">
                <img *ngIf="template.file_url" [src]="template.file_url" [alt]="template.name" class="preview-thumbnail"
                  title="Vista previa">
                <div *ngIf="!template.file_url" class="no-preview">
                  <i class="fas fa-image"></i>
                  <span>Sin imagen</span>
                </div>
              </div>
            </td>
            <td>
              <div class="template-info">
                <strong>{{ template.name }}</strong>
                <small *ngIf="template.description">{{ template.description }}</small>
              </div>
            </td>
            <td>
              <span class="type-badge" [class]="getActivityTypeBadgeClass(template.activity_type)">
                {{ getActivityTypeLabel(template.activity_type) }}
              </span>
            </td>
            <td>
              <span class="badge" [class]="getStatusBadgeClass(template.status)">
                {{ getStatusLabel(template.status) }}
              </span>
            </td>
            <td>{{ template.created_at | date:'dd/MM/yyyy' }}</td>
            <td>
              <div class="action-buttons">
                <button class="btn btn-sm btn-outline-secondary" (click)="openEditModal(template)"
                  title="Editar plantilla">
                  <i class="fas fa-edit"></i>
                </button>
                <button class="btn btn-sm btn-outline-danger" (click)="openDeleteModal(template)"
                  [disabled]="(template.certificates_count || 0) > 0"
                  [title]="(template.certificates_count || 0) > 0 ? 'No se puede eliminar: plantilla en uso (' + (template.certificates_count || 0) + ')' : 'Eliminar plantilla'">
                  <i class="fas fa-trash"></i>
                </button>
                <small class="inline-hint" *ngIf="(template.certificates_count || 0) > 0">
                  No se puede eliminar: vinculada a {{ template.certificates_count }} certificado(s)
                </small>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Paginación -->
  <div class="pagination-container" *ngIf="totalPages() > 1 && !isLoading() && !errorMessage()">
    <div class="pagination-info">
      Mostrando {{ (currentPage() - 1) * perPage() + 1 }} -
      {{ Math.min(currentPage() * perPage(), totalItems()) }} de {{ totalItems() }} plantillas
    </div>

    <nav class="pagination">
      <button class="page-link" [disabled]="currentPage() === 1" (click)="goToPage(currentPage() - 1)">
        <i class="fas fa-chevron-left"></i>
      </button>

      <button *ngFor="let page of [].constructor(totalPages()); let i = index" class="page-link"
        [class.active]="currentPage() === i + 1" (click)="goToPage(i + 1)">
        {{ i + 1 }}
      </button>

      <button class="page-link" [disabled]="currentPage() === totalPages()" (click)="goToPage(currentPage() + 1)">
        <i class="fas fa-chevron-right"></i>
      </button>
    </nav>
  </div>
</div>



<!-- Modal para crear plantilla -->
<div class="modal-overlay" *ngIf="showCreateModal()">
  <div class="modal-dialog" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>Nueva Plantilla</h3>
      <button class="btn-close" (click)="closeModals()">
        <i class="fas fa-times"></i>
      </button>
    </div>

    <form [formGroup]="templateForm" (ngSubmit)="createTemplate()">
      <div class="modal-body">
        <div class="form-group">
          <label>Nombre *</label>
          <input class="form-control" type="text" formControlName="name" placeholder="Nombre de la plantilla">
          <div class="error-message" *ngIf="templateForm.get('name')?.touched && templateForm.get('name')?.errors">
            <span *ngIf="templateForm.get('name')?.errors?.['required']">El nombre es requerido</span>
            <span *ngIf="templateForm.get('name')?.errors?.['minlength']">El nombre debe tener al menos 3
              caracteres</span>
          </div>
        </div>

        <div class="form-group">
          <label>Descripción</label>
          <textarea class="form-control" formControlName="description" placeholder="Descripción de la plantilla"
            rows="3"></textarea>
        </div>

        <div class="form-group">
          <label>Tipo de Actividad *</label>
          <select class="form-control" formControlName="activity_type">
            <option *ngFor="let type of activityTypes" [value]="type.value">
              {{ type.label }}
            </option>
          </select>
        </div>

        <div class="form-group">
          <label>Estado *</label>
          <select class="form-control" formControlName="status">
            <option *ngFor="let status of statusOptions" [value]="status.value">
              {{ status.label }}
            </option>
          </select>
        </div>

        <!-- Subida de imagen de fondo de plantilla -->
        <div class="form-group">
          <label>Imagen de Fondo de Plantilla *</label>
          <div class="file-upload-container">
            <input id="templateFileInput" class="file-input" type="file" accept="image/*"
              (change)="onTemplateFileSelected($event)">
            <label for="templateFileInput" class="file-upload-label">
              <i class="fas fa-upload"></i>
              <span>Selecciona una imagen (JPG/PNG)</span>
            </label>
            <small class="text-muted">Se usará como fondo del certificado.</small>
            <div class="hint-message hint-warning" *ngIf="!uploadedPreviewUrl">Sube una imagen de plantilla antes de
              crear</div>
            <div class="hint-message hint-success" *ngIf="uploadedPreviewUrl">Posiciona tus componentes dentro de la
              imagen</div>
            <div class="image-preview-container" *ngIf="uploadedPreviewUrl">
              <img [src]="uploadedPreviewUrl" alt="Vista previa" class="template-preview-image">
              <button type="button" class="btn-remove-image" (click)="removeSelectedImage()"
                title="Quitar imagen">×</button>
            </div>
          </div>
          <div class="position-editor-section" *ngIf="uploadedPreviewUrl">
            <button type="button" class="btn btn-primary btn-position-editor" (click)="openPositionEditor()">
              <i class="fas fa-pencil-ruler"></i>
              Abrir editor de posiciones
            </button>
            <small>Configura posiciones y estilo de Nombres, Fecha y QR sobre la imagen.</small>
          </div>
        </div>


      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="closeModals()">
          Cancelar
        </button>
        <button type="submit" class="btn btn-primary" [disabled]="templateForm.invalid || isLoading() || !uploadedFile">
          <i class="fas fa-spinner fa-spin" *ngIf="isLoading()"></i>
          Crear Plantilla
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Editor visual -->
<div class="modal-overlay editor-overlay" *ngIf="showEditor()">
  <div class="modal-dialog" (click)="$event.stopPropagation()" style="max-width: 1000px; width: 90vw;">
    <div class="modal-header">
      <h3>Editor de Plantilla</h3>
      <div class="editor-toolbar">
        <button class="btn btn-secondary" (click)="addNameElement()" [class.btn-selected]="hasElement('name')">
          <i class="fas fa-user"></i>
          Agregar Nombres
        </button>
        <button class="btn btn-secondary" (click)="addDateElement()" [class.btn-selected]="hasElement('date')">
          <i class="fas fa-calendar"></i>
          Fecha de Emisión
        </button>
        <button class="btn btn-secondary" (click)="addQrElement()" [class.btn-selected]="hasElement('qr')">
          <i class="fas fa-qrcode"></i>
          Agregar QR
        </button>
      </div>
      <button class="btn-close" (click)="closePositionEditor()">
        <i class="fas fa-times"></i>
      </button>
    </div>

    <div class="modal-body">
      <div class="image-size-info" *ngIf="editorCanvasSize() as cs">
        <small>
          Render: {{ cs.width }}×{{ cs.height }} px
          | Base: {{ selectedTemplate()?.background_image_size?.width || '—' }}×{{
          selectedTemplate()?.background_image_size?.height || '—' }} px
        </small>
      </div>
      <div class="editor-canvas" *ngIf="uploadedPreviewUrl">
        <div class="editor-layer"
          [style.transform]="'translate(' + backgroundOffset().x + 'px, ' + backgroundOffset().y + 'px)'">
          <img [src]="uploadedPreviewUrl" class="editor-background" alt="Fondo">

          <!-- Elementos superpuestos -->
          <div *ngFor="let el of editorElements(); let i = index" class="editor-element"
            [class.selected]="selectedElementIndex() === i" [style.top.px]="el.y" [style.left.px]="el.x"
            [style.transform]="'rotate(' + (el.rotation || 0) + 'deg)'" (mousedown)="startDrag($event, i)"
            (click)="selectElement(i)">
            <button type="button" class="delete-element-btn" *ngIf="selectedElementIndex() === i"
              (click)="deleteSelectedElement()" title="Eliminar">
              <i class="fas fa-trash"></i>
            </button>
            <ng-container [ngSwitch]="el.type">
              <div *ngSwitchCase="'name'" class="text-element" [style.fontFamily]="el.fontFamily || 'Arial'"
                [style.fontSize.px]="el.fontSize || 28" [style.color]="el.color || '#000'"
                [style.fontWeight]="el.fontWeight || 'normal'">
                Nombres Completos
                <span class="hint">Posiciona y ajusta fuente/estilo</span>
              </div>
              <div *ngSwitchCase="'date'" class="text-element" [style.fontFamily]="el.fontFamily || 'Arial'"
                [style.fontSize.px]="el.fontSize || 16" [style.color]="el.color || '#333'"
                [style.fontWeight]="el.fontWeight || 'normal'">
                Fecha de Emisión
              </div>
              <div *ngSwitchCase="'qr'" class="qr-element" [style.width.px]="el.width || 120"
                [style.height.px]="el.height || 120">
                <i class="fas fa-qrcode"></i>
              </div>
            </ng-container>
          </div>
        </div>
      </div>

      <!-- Panel de propiedades del elemento seleccionado -->
      <div class="editor-properties" *ngIf="selectedElementIndex() !== null">
        <h4>Propiedades del elemento</h4>
        <div class="form-row" style="display: flex; gap: 12px; align-items: flex-end; grid-template-columns: none;">
          <!-- Coordenadas -->
          <div class="form-group" style="flex: 0 0 auto; min-width: 80px;">
            <label>Posición</label>
            <div class="coords-inline" style="font-size: 12px; padding: 10px 0;">
              <span style="margin-right: 8px;">X: {{ getSelectedRelativeX() }}</span>
              <span>Y: {{ getSelectedRelativeY() }}</span>
            </div>
          </div>

          <!-- Fuente (solo si no es QR) -->
          <!-- Fuente (solo si no es QR) -->
          <div class="form-group" *ngIf="!isSelectedType('qr')" style="flex: 2;">
            <label>Fuente</label>
            <div style="display: flex; gap: 8px;">
              <select class="form-control" [value]="getSelected()?.fontFamily || ''" (change)="updateFontFamily($event)"
                style="flex: 1;">
                <option *ngFor="let font of availableFonts()" [value]="font.name" [style.fontFamily]="font.name">{{
                  font.name }}</option>
              </select>
              <button class="btn-bold" [class.active]="getSelected()?.fontWeight === 'bold'"
                (click)="updateFontWeight()" title="Negrita">
                <i class="fas fa-bold"></i>
              </button>
            </div>
          </div>

          <!-- Tamaño -->
          <div class="form-group" style="flex: 0 0 80px;">
            <label>Tamaño</label>
            <input *ngIf="!isSelectedType('qr')" type="number" class="form-control" (input)="updateFontSize($event)"
              [value]="getSelected()?.fontSize || 28" min="3" max="100">
            <input *ngIf="isSelectedType('qr')" type="number" class="form-control" (input)="updateQrSize($event)"
              [value]="getSelected()?.width || 120" min="20" max="1000">
          </div>

          <!-- Color (solo si no es QR) -->
          <div class="form-group" *ngIf="!isSelectedType('qr')" style="flex: 0 0 auto;">
            <label>Color</label>
            <div class="color-picker-wrapper" title="Color de fuente" style="width: 70px;">
              <div class="color-picker-btn" (click)="colorInput.click()">
                <div class="color-icon-wrapper">
                  <i class="fas fa-font font-icon"></i>
                  <div class="color-bar" [style.backgroundColor]="getSelected()?.color || '#000000'"></div>
                </div>
                <i class="fas fa-caret-down dropdown-arrow"></i>
              </div>
              <input #colorInput type="color" class="hidden-color-input" [value]="getSelected()?.color || '#000000'"
                (input)="updateColor($event)">
            </div>
          </div>

          <!-- Rotación -->
          <div class="form-group" style="flex: 1;">
            <label>Rotación</label>
            <input type="number" class="form-control" (input)="updateRotation($event)"
              [value]="getSelected()?.rotation || 0" min="-180" max="180">
          </div>
        </div>
      </div>
    </div>

    <div class="modal-footer">
      <button type="button" class="btn btn-secondary" (click)="cancelEditor()">Cancelar</button>
      <button type="button" class="btn btn-primary" (click)="saveEditor()">Guardar</button>
    </div>
  </div>
</div>

<!-- Modal para editar plantilla -->
<div class="modal-overlay" *ngIf="showEditModal()">
  <div class="modal-dialog" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>Editar Plantilla</h3>
      <button class="btn-close" (click)="closeModals()">
        <i class="fas fa-times"></i>
      </button>
    </div>

    <form [formGroup]="templateForm" (ngSubmit)="updateTemplate()">
      <div class="modal-body">
        <div class="form-group">
          <label>Nombre *</label>
          <input class="form-control" type="text" formControlName="name" placeholder="Nombre de la plantilla">
          <div class="error-message" *ngIf="templateForm.get('name')?.touched && templateForm.get('name')?.errors">
            <span *ngIf="templateForm.get('name')?.errors?.['required']">El nombre es requerido</span>
            <span *ngIf="templateForm.get('name')?.errors?.['minlength']">El nombre debe tener al menos 3
              caracteres</span>
          </div>
        </div>

        <div class="form-group">
          <label>Descripción</label>
          <textarea class="form-control" formControlName="description" placeholder="Descripción de la plantilla"
            rows="3"></textarea>
        </div>

        <div class="form-group">
          <label>Tipo de Actividad *</label>
          <select class="form-control" formControlName="activity_type">
            <option *ngFor="let type of activityTypes" [value]="type.value">
              {{ type.label }}
            </option>
          </select>
        </div>

        <div class="form-group">
          <label>Estado *</label>
          <select class="form-control" formControlName="status">
            <option *ngFor="let status of statusOptions" [value]="status.value">
              {{ status.label }}
            </option>
          </select>
        </div>

        <div class="form-group">
          <label>Imagen de Fondo</label>
          <div class="file-upload-container">
            <!-- Input de subida (solo visible si no hay imagen) -->
            <div *ngIf="!uploadedPreviewUrl">
              <input id="templateFileInputEdit" class="file-input" type="file" accept="image/*"
                (change)="onTemplateFileSelected($event)">
              <label for="templateFileInputEdit" class="file-upload-label">
                <i class="fas fa-upload"></i>
                <span>Selecciona una imagen (JPG/PNG)</span>
              </label>
              <small class="text-muted">Sube una nueva imagen para reemplazar la actual.</small>
            </div>

            <!-- Mensajes de ayuda -->
            <div class="hint-message hint-warning" *ngIf="!uploadedPreviewUrl">Sube una imagen de plantilla para
              editar</div>
            <div class="hint-message hint-success" *ngIf="uploadedPreviewUrl">Posiciona tus componentes dentro de la
              imagen</div>

            <!-- Vista previa (imagen actual o nueva) -->
            <div class="image-preview-container" *ngIf="uploadedPreviewUrl">
              <img [src]="uploadedPreviewUrl" alt="Vista previa" class="template-preview-image">
              <button type="button" class="btn-remove-image" (click)="removeSelectedImage()" title="Cambiar imagen">
                <i class="fas fa-sync-alt"></i>
              </button>
            </div>

            <!-- Botón del editor -->
            <div class="position-editor-section" *ngIf="uploadedPreviewUrl">
              <button type="button" class="btn btn-secondary btn-position-editor" (click)="openPositionEditor()">
                <i class="fas fa-pencil-ruler"></i>
                Abrir editor de posiciones
              </button>
            </div>
          </div>
        </div>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="closeModals()">
          Cancelar
        </button>
        <button type="submit" class="btn btn-primary" [disabled]="templateForm.invalid || isLoading()">
          <i class="fas fa-spinner fa-spin" *ngIf="isLoading()"></i>
          Actualizar Plantilla
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Modal para confirmar eliminación -->
<div class="modal-overlay" *ngIf="showDeleteModal()">
  <div class="modal-dialog modal-sm" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>Confirmar Eliminación</h3>
      <button class="btn-close" (click)="closeModals()">
        <i class="fas fa-times"></i>
      </button>
    </div>

    <div class="modal-body">
      <div class="confirm-delete">
        <i class="fas fa-exclamation-triangle"></i>
        <p>¿Estás seguro de que deseas eliminar la plantilla <strong>{{ selectedTemplate()?.name }}</strong>?</p>
        <p class="warning">Esta acción no se puede deshacer.</p>
      </div>
    </div>

    <div class="modal-footer">
      <button type="button" class="btn btn-secondary" (click)="closeModals()">
        Cancelar
      </button>
      <button type="button" class="btn btn-danger" (click)="deleteTemplate()" [disabled]="isLoading()">
        <i class="fas fa-spinner fa-spin" *ngIf="isLoading()"></i>
        Eliminar
      </button>
    </div>
  </div>
</div>



<!-- Modal para ver detalles -->
<div class="modal-overlay" *ngIf="showViewModal()">
  <div class="modal-dialog" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>Detalles de la Plantilla</h3>
      <button class="btn-close" (click)="closeModals()">
        <i class="fas fa-times"></i>
      </button>
    </div>

    <div class="modal-body" *ngIf="selectedTemplate()">
      <div class="template-details-enhanced">
        <!-- Header con información principal -->
        <div class="detail-header">
          <div class="template-icon">
            <i class="fas fa-file-alt"></i>
          </div>
          <div class="template-info">
            <h3>{{ selectedTemplate()?.name }}</h3>
            <div class="template-meta">
              <span class="badge" [class]="getStatusBadgeClass(selectedTemplate()?.status || '')">
                <i class="fas"
                  [class]="selectedTemplate()?.status === 'active' ? 'fa-check-circle' : 'fa-times-circle'"></i>
                {{ getStatusLabel(selectedTemplate()?.status || '') }}
              </span>
              <span class="type-badge" [class]="getActivityTypeBadgeClass(selectedTemplate()?.activity_type || '')">
                <i class="fas fa-tag"></i>
                {{ getActivityTypeLabel(selectedTemplate()?.activity_type || '') }}
              </span>
            </div>
          </div>
        </div>

        <!-- Información detallada -->
        <div class="detail-sections">
          <div class="detail-section">
            <h4><i class="fas fa-info-circle"></i> Información General</h4>
            <div class="detail-grid">
              <div class="detail-item" *ngIf="selectedTemplate()?.description">
                <label>Descripción:</label>
                <p>{{ selectedTemplate()?.description }}</p>
              </div>
              <div class="detail-item">
                <label>Fecha de Creación:</label>
                <p><i class="fas fa-calendar-plus"></i> {{ selectedTemplate()?.created_at | date:'dd/MM/yyyy HH:mm' }}
                </p>
              </div>
              <div class="detail-item">
                <label>Última Actualización:</label>
                <p><i class="fas fa-clock"></i> {{ selectedTemplate()?.updated_at | date:'dd/MM/yyyy HH:mm' }}</p>
              </div>
            </div>
          </div>

          <!-- Vista previa mejorada -->
          <div class="detail-section" *ngIf="selectedTemplate()?.file_url">
            <h4><i class="fas fa-image"></i> Vista Previa</h4>
            <div class="enhanced-preview-container">
              <div class="preview-wrapper">
                <app-template-preview [template]="selectedTemplate()" [showElements]="true"
                  [sampleUserName]="'Juan Pérez'" title="Vista previa de la plantilla"></app-template-preview>
                <div class="preview-overlay">
                  <i class="fas fa-search-plus"></i>
                  <span>Click para ampliar</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Estadísticas -->
          <div class="detail-section">
            <h4><i class="fas fa-chart-bar"></i> Estadísticas</h4>
            <div class="stats-grid">
              <div class="stat-item">
                <div class="stat-value">{{ selectedTemplate()?.certificates_count || 0 }}</div>
                <div class="stat-label">Certificados Generados</div>
              </div>
              <div class="stat-item">
                <div class="stat-value">{{ selectedTemplate()?.activity_type || 'N/A' }}</div>
                <div class="stat-label">Tipo de Actividad</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="modal-footer enhanced-footer">
      <button type="button" class="btn btn-secondary" (click)="closeModals()">
        <i class="fas fa-times"></i>
        Cerrar
      </button>
      <button type="button" class="btn btn-primary" (click)="openEditModal(selectedTemplate()!)">
        <i class="fas fa-edit"></i>
        Editar Plantilla
      </button>
    </div>
  </div>
</div>